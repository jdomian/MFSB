<!DOCTYPE html>
<html>
  <head>
    <link href="libs/bootstrap/css/bootstrap.min.css" rel="stylesheet" />
    <link href="css/styles.css" rel="stylesheet" />
    <style>

    </style>
  </head>
  <body>
    <div id="screens-carousel" class="carousel" data-bs-interval="false" data-bs-wrap="true">
      <div class="carousel-indicators">
        <button type="button" data-bs-target="#screens-carousel" data-bs-slide-to="0" class="active" aria-current="true" aria-label="Slide 1"></button>
        <button type="button" data-bs-target="#screens-carousel" data-bs-slide-to="1" aria-label="Slide 2"></button>
        <button type="button" data-bs-target="#screens-carousel" data-bs-slide-to="2" aria-label="Slide 3"></button>
      </div>
      <div class="carousel-inner">
        <div class="carousel-item active ammoScreen">
          <div id="ammoScreen">
            <div class="mode-screen">
              <ul class="modes">
                <li>15</li>
                <li class="selected">10</li>
                <li>7</li>
              </ul>
            </div>
            <div class="circular">
              <div class="inner"></div>
              <div class="number ammoCount" id="ammoCount"></div>
              <div class="circle">
                <div class="bar left">
                  <div class="progress"></div>
                </div>
                <div class="bar right">
                  <div class="progress"></div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="carousel-item">
            <div id="targetScreen">
              <div class="number ammoCount"></div>
              <div class="crosshair type-1">
                <!-- <div class="circular">
                  <div class="inner"></div>
                  <div class="circle">
                    <div class="bar left">
                      <div class="progress"></div>
                    </div>
                    <div class="bar right">
                      <div class="progress"></div>
                    </div>
                  </div>
                </div> -->
              </div>
              <img id="webcamPi" class="x1" src="http://10.0.0.222:3000/stream.mjpg" />
              <div class="zoomLevel"></div>
            </div>
        </div>
        <!-- <div class="carousel-item">
            <div id="compassScreen">
              <canvas crossOrigin="anonymous" id='leftVideo' width='110px' height='240px' style="display: none;"></canvas>
              <video muted="muted" controls crossOrigin="anonymous" id="rightVideo" width='240px' height='240px'></video>
            </div>
        </div> -->
      </div>
      <div class="debug" style="display: flex;">
        <button class="btn btn-debug btn-danger" id="debugFire">Fire</button>
        <button class="btn btn-debug btn-success" id="debugSelect">Select</button>
        <button class="btn btn-debug btn-primary" id="debugMode">Mode</button>
        <button class="btn btn-debug btn-info" id="debugCycle">Cycle</button>
      </div>
    </div>
    <div id="reload-debug">
      <div>Reload<input type="button" id="btnReload" value="1"></div>
    </div>


<!--
    <section id="demos">
      <h2>Demo: Classifying Images</h2>
      <p><em>Click on an image below</em> to try and recognize what is in the image using the power of Machine Learning! Notice how in this demo we not only know if the object is in the image, but also its position in the image. Very useful.</p>

      <div class="classifyOnClick">
        <img src="https://cdn.glitch.com/74418d0b-3465-49a2-8c71-a721b7734473%2Fdoggo.jpg?v=1592266725716" crossorigin="anonymous" title="Click to get classification!" />
      </div>
      <div class="classifyOnClick">
        <img src="https://cdn.glitch.com/74418d0b-3465-49a2-8c71-a721b7734473%2Fcoupledog.jpg?v=1591311552891" crossorigin="anonymous" title="Click to get classification!" />
      </div>


      <h2>Demo: Webcam continuous classification</h2>
      <p>Hold some objects up close to your webcam to get a real-time classification! You must be on <a href="https://glitch.com/~tensorflow-js-object-detection">the https version of the website</a> for this to work. When ready click "enable webcam" below and accept access to the webcam when the browser asks (check the top left of your window)</p>
      
      <div id="liveView" class="videoView">
        <button id="webcamButton">Enable Webcam</button>
        <video crossOrigin="anonymous" id="webcam" autoplay></video>
      </div>
    </section>
  -->
    <script src="js/jquery-3.6.0.min.js"></script> <!-- include socket.io client side script -->
    <script src="libs/bootstrap/js/bootstrap.min.js"></script> <!-- include socket.io client side script -->
    <script src="socket.io/socket.io.js"></script> <!-- include socket.io client side script -->
    <script>

      //settings
      var ammoCountSetting = localStorage.getItem('ammoCountSetting');

      var hold = 0;
      var triggerHold = 0;
      var triggerHoldReload = false;
      var maxRounds = ammoCountSetting;
      var currentRounds = maxRounds;
      var ammoCount = $('.ammoCount');
      var btnReload = document.getElementById("btnReload");
      var currentView = 0;

      var debugTriggerAmmo = maxRounds;
      var debugTiggerPin = 0;



      // -- ACTIONS -- //

      //Trigger to count down ammo
      function fire(count) {
        console.log(count); //Log when button is pushed
        ammoCount.text(count);
        let deg = 360 / maxRounds;
        let precentDeg = 180 - ((maxRounds - count) * deg);

        if (count / maxRounds >= 0.5) {
            $('#ammoScreen .bar.right').css('transform', 'rotate(' + precentDeg + 'deg)');
        }
        else if (count < 0) {
          $('.ammoScreen').addClass('reload');
        }
        else {
            $('#ammoScreen .bar.right').css('transform', 'rotate(180deg)').addClass('transparent');
            $('#ammoScreen .bar.left').css('transform', 'rotate(' + precentDeg + 'deg)');
        }

      }

      //Reload on ammo count screen
      function reload() {
          var data = ammoCountSetting;
          socket.emit("reload", data); //send button status to server (as 1 or 0)
          ammoCount.text(maxRounds);
          $('.ammoScreen').removeClass('reloading reload');
          $('#ammoScreen .bar.right').css('transform', 'rotate(180deg)').removeClass('transparent');
          $('#ammoScreen .bar.left').css('transform', 'inherit');
      }

      //Screen cycling
      function changeScreen() {
        console.log('Cycling screen');
        clearTimeout(hold);
        $('.carousel').carousel('next');
      }

      //Select
      function select() {
        switch (currentView) {
          case 0:
            console.log('Ammo select');
            localStorage.setItem('ammoCountSetting', ammoCountSetting);
            $('#ammoScreen .mode-screen').removeClass('configure');
            reload();
            window.location.reload();
            break;
          case 1:
            console.log('Aim select');
            let $cam = $('#webcamPi');
            let $zLvl = $('.zoomLevel');
            if ($cam.hasClass('x1')) {
              $cam.removeClass('x1').addClass('x2');
              $zLvl.text('2x');
            }
            if ($cam.hasClass('x2')) {
              $cam.removeClass('x2').addClass('x3');
              $zLvl.text('3x');
            }
            else if ($cam.hasClass('x3')) {
              $cam.removeClass('x3').addClass('x5');
              $zLvl.text('5x');
            }
            else if ($cam.hasClass('x5')) {
              $cam.removeClass('x5').addClass('x10');
              $zLvl.text('10x');
            }
            else if ($cam.hasClass('x10')) {
              $cam.removeClass('x10').addClass('x1');
              $zLvl.text('');
            }
            
            break;
          case 2:
          default:
            console.log('slide');
        }
      }

      //Select
      function mode() {
        switch (currentView) {
          case 0:

            var $modeScreen = $('#ammoScreen .mode-screen');
            var $modes = $('#ammoScreen .mode-screen .modes');


            
            $modes.children('li').each(function(i,e){
                if(e.innerText == ammoCountSetting)
                {
                    $(e).addClass("selected");
                }
            });
            

            if ($modeScreen.hasClass('configure')) {
              var $selectedMode = $modes.children('li.selected').removeClass("selected");
              var $divs = $selectedMode.parent().children();
              $divs.eq((($divs.index($selectedMode) + 1) % $divs.length)).addClass("selected");
              ammoCountSetting = $modes.children('li.selected').text();
            }

            $modeScreen.addClass('configure');
            

          
            break;
          case 0:
            console.log('Mangoes and papayas are $2.79 a pound.');
            break;
          case 2:
          default:
            console.log('slide');
        }
      } 




      // -- EVENTS -- //

      function triggerBtn([ammo, pin]) {
        currentRounds = ammo;
        if (pin == 0) {
          triggerHold = setTimeout(function(){
            triggerHoldReload = true;
            $('.ammoScreen').addClass('reloading');
          },5000);
          fire(currentRounds);
        }
        else if (pin == 1 && triggerHoldReload) {
          reload();
          triggerHoldReload = false;
          clearTimeout(triggerHold);
        }
        else {
          console.log(triggerHold);
          console.log('Changin Mode/Selection');
          triggerHoldReload == false;
          clearTimeout(triggerHold);
        }
      }


      var socket = io(); //load socket.io-client and connect to the host that serves the page

      //Trigger button events 
      socket.on("triggerBtn", ([ammo, pin]) => {
        triggerBtn([ammo, pin]);
        debugTriggerAmmo = ammo;
        debugTiggerPin = pin;
      });

      socket.on("selectBtn", (arg) => {
        select();
      });


      socket.on("modeBtn", (arg) => {
        mode();
      });

      socket.on("cycleScreen", (arg) => {
        if (arg == 0) {
          changeScreen();
        }
        //Save for later: change screen on holding of button for 3 sec
        // if (arg == 0) {
        //   hold = setTimeout("changeScreen()",3000);
        // }
        // else {
        //   console.log(hold);
        //   console.log('Changing Mode/Selection');
        //   clearTimeout(hold);
        // }
      });

      $(document).ready(function(){
        $('.number.ammoCount').text(ammoCountSetting);
      });

      //Debugging
      $('#debugFire').click(function(){
        triggerBtn([debugTriggerAmmo, debugTiggerPin]);
      });
      $('#debugCycle').click(function(){
        $('.carousel').carousel('next');
      });
      $('#debugSelect').click(function(){
        select();
      });
      $('#debugMode').click(function(){
        mode();
      });

      $('.carousel').on('slid.bs.carousel', function (e) {
        currentView = e.to;
      });




      
</script>

<!--Converts MJPEG to canvas for streaming.-->
<!-- <script language="JavaScript">
  var ctx = document.getElementById('leftVideo').getContext('2d');
  var img = document.getElementById('webcamPi');

  //var img = new Image();
  img.onload = function() {
    ctx.drawImage(img, 0, 0);
  };


  //var theDate = new Date();
  //img.src = "http://10.0.2.222:3000/stream.mjpg";
  window.setInterval("refreshCanvas()", 10);
function refreshCanvas(){
  ctx.drawImage(img, 0, 0);
}; -->


<!-- var canvas = document.getElementById('leftVideo');
var vid = document.getElementById('rightVideo');
var ctx = canvas.getContext('2d'); // or whatever ('webgl', 'webgl2' ...)
var stream = canvas.captureStream(30);
vid.srcObject = stream;
vid.play(); -->

</script>
<!--
<script src="https://webrtc.github.io/adapter/adapter-1.0.7.js"></script>
<script src="https://lonekorean.github.io/diff-cam-scratchpad/diff-cam-engine.js"></script>
<script src="js/diff-cam.js"></script>
-->

<!-- Import TensorFlow.js library -->
<!--<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.11.0/dist/tf.min.js" type="text/javascript"></script>-->
    
<!-- Load the coco-ssd model to use to recognize things in images -->
<!--<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd"></script>-->
<!--<script src="js/tf-scripts.js"></script>-->
<!-- <script src="https://webrtc.github.io/adapter/adapter-latest.js"></script> -->



</body>
</html>